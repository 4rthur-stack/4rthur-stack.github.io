<!DOCTYPE html>
<html class="light" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>GPA Strategist Dashboard</title>
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link href="https://fonts.gstatic.com" crossorigin="" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700&family=Noto+Sans:wght@400;500;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/vue@3.3.4/dist/vue.global.prod.js"></script>

    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: { "uci-blue": "#0064A4", "uci-gold": "#FFD200", "background-light": "#f6f7f8" },
                    fontFamily: { "display": ["Lexend", "sans-serif"], "body": ["Noto Sans", "sans-serif"] },
                },
            },
        }
    </script>
</head>
<body class="bg-background-light font-display text-[#0d161b] min-h-screen flex flex-col">

    <div id="app" class="flex flex-col min-h-screen" v-cloak>
        
        <div class="w-full bg-white border-b border-[#e7eff3] sticky top-0 z-50">
            <header class="flex items-center justify-between px-4 md:px-10 py-3 max-w-[1440px] mx-auto w-full">
                <div class="flex items-center gap-4 text-uci-blue">
                    <div class="size-8 flex items-center justify-center bg-uci-gold rounded-lg text-uci-blue">
                        <span class="material-symbols-outlined">school</span>
                    </div>
                    <h2 class="text-uci-blue text-xl font-bold">GPA Strategist</h2>
                </div>
                <div class="hidden md:block text-xs font-bold" :class="statusColor">
                    {{ statusText }}
                </div>
            </header>
        </div>

        <div class="flex-1 flex flex-col lg:flex-row gap-6 px-4 md:px-10 py-6 max-w-[1440px] mx-auto w-full">
            
            <div class="flex flex-col flex-1 gap-6 min-w-0">
                <div class="flex flex-col gap-2">
                    <h1 class="text-3xl font-bold">Find GE Courses</h1>
                    <p class="text-sm text-gray-500">Search by Department (e.g. ECON, COMPSCI).</p>
                </div>

                <div class="bg-white p-4 rounded-xl shadow-sm border flex flex-col md:flex-row gap-4">
                    <input v-model="searchQuery" @keyup.enter="searchCourses" class="flex-1 bg-gray-50 border border-gray-200 rounded-lg p-3" placeholder="Enter department (e.g. ECON)..." type="text"/>
                    <button @click="searchCourses" class="bg-uci-blue text-white px-6 py-3 rounded-lg font-bold hover:opacity-90">
                        {{ loading ? 'Loading...' : 'Search' }}
                    </button>
                </div>

                <div v-if="errorMsg" class="bg-yellow-50 border-l-4 border-yellow-400 p-4 text-yellow-700 text-sm font-medium">
                    {{ errorMsg }}
                </div>

                <div class="grid grid-cols-1 xl:grid-cols-2 gap-4">
                    <div v-if="loading" class="col-span-full py-10 text-center text-gray-500">Connecting to UCI Database...</div>
                    
                    <div v-if="!loading && courses.length === 0" class="col-span-full py-10 text-center text-gray-500 border-2 border-dashed rounded-xl">
                        No courses found. Try searching <b>ECON</b> or <b>BIO SCI</b>.
                    </div>

                    <div v-for="course in courses" :key="course.id" class="bg-white p-5 rounded-xl shadow-sm border hover:shadow-md transition flex gap-4">
                        <div class="hidden sm:flex size-14 bg-blue-50 text-uci-blue items-center justify-center rounded-lg font-bold text-xl shrink-0">UCI</div>
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-start">
                                <h3 class="font-bold text-uci-blue text-lg truncate">{{ course.id }}</h3>
                                <span class="bg-green-100 text-green-700 text-xs font-bold px-2 py-1 rounded-full">GPA: {{ course.demoGPA || '3.50' }}</span>
                            </div>
                            <p class="text-sm font-medium truncate">{{ course.title }}</p>
                            <button @click="addToPlan(course)" class="mt-3 text-sm text-uci-blue font-bold flex items-center gap-1 hover:underline">
                                <span class="material-symbols-outlined text-sm">add_circle</span> Add to Plan
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <aside class="w-full lg:w-[400px] flex flex-col gap-6">
                <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-t-uci-gold sticky top-24">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <span class="material-symbols-outlined text-uci-gold">analytics</span> My GPA
                    </h2>

                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <label class="text-xs font-bold text-gray-500 uppercase">Current GPA
                            <input v-model.number="currentGPA" class="w-full mt-1 border-gray-200 rounded p-2" type="number" step="0.01">
                        </label>
                        <label class="text-xs font-bold text-gray-500 uppercase">Units Done
                            <input v-model.number="currentUnits" class="w-full mt-1 border-gray-200 rounded p-2" type="number">
                        </label>
                    </div>

                    <div class="bg-gray-50 rounded-lg p-4 mb-4 max-h-[300px] overflow-y-auto">
                        <p class="text-xs font-bold text-gray-400 mb-2 uppercase">Planned Courses</p>
                        <div v-if="plannedCourses.length === 0" class="text-center text-sm text-gray-400 py-4">List is empty</div>
                        
                        <div v-for="(course, index) in plannedCourses" :key="index" class="flex items-center justify-between mb-2 bg-white p-2 rounded border">
                            <div class="truncate flex-1 mr-2">
                                <div class="font-bold text-xs text-uci-blue">{{ course.id }}</div>
                            </div>
                            <select v-model.number="course.gradePoint" class="text-xs border-gray-200 rounded py-1 px-1 w-20">
                                <option :value="4.0">A (4.0)</option>
                                <option :value="3.7">A- (3.7)</option>
                                <option :value="3.3">B+ (3.3)</option>
                                <option :value="3.0">B (3.0)</option>
                            </select>
                            <button @click="removeCourse(index)" class="ml-2 text-red-400 hover:text-red-600">✕</button>
                        </div>
                    </div>

                    <div class="bg-uci-blue text-white p-6 rounded-xl text-center">
                        <p class="text-sm uppercase opacity-70">Projected GPA</p>
                        <p class="text-5xl font-bold my-2">{{ projectedGPA }}</p>
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <script>
        // !!! 修复 2: 全局错误拦截 (白屏终结者) !!!
        window.onerror = function(msg, source, lineno, colno, error) {
            alert("代码出错了！\nError: " + msg + "\nLine: " + lineno);
            return false;
        };

        const { createApp, ref, computed, onMounted, watch } = Vue;

        createApp({
            setup() {
                const courses = ref([]);
                const loading = ref(false);
                const errorMsg = ref('');
                const searchQuery = ref('ECON'); 
                
                // !!! 修复 3: 安全读取 LocalStorage (防止崩溃) !!!
                let savedData = {};
                try {
                    savedData = JSON.parse(localStorage.getItem('uci-gpa-data')) || {};
                } catch (e) {
                    console.error("Cache corrupted, resetting.");
                    localStorage.removeItem('uci-gpa-data');
                }

                const currentGPA = ref(savedData.currentGPA || 3.40);
                const currentUnits = ref(savedData.currentUnits || 45);
                const plannedCourses = ref(savedData.plannedCourses || []);

                // 自动保存
                watch([currentGPA, currentUnits, plannedCourses], () => {
                    localStorage.setItem('uci-gpa-data', JSON.stringify({
                        currentGPA: currentGPA.value,
                        currentUnits: currentUnits.value,
                        plannedCourses: plannedCourses.value
                    }));
                }, { deep: true });

                const projectedGPA = computed(() => {
                    const cPoints = currentGPA.value * currentUnits.value;
                    let pPoints = 0;
                    let pUnits = 0;
                    
                    plannedCourses.value.forEach(c => {
                        const u = Number(c.units || 4); // 强制转为数字
                        pPoints += (c.gradePoint * u);
                        pUnits += u;
                    });

                    const totalUnits = currentUnits.value + pUnits;
                    return totalUnits === 0 ? "0.00" : ((cPoints + pPoints) / totalUnits).toFixed(2);
                });

                const statusColor = computed(() => errorMsg.value ? 'text-yellow-600' : 'text-green-600');
                const statusText = computed(() => errorMsg.value ? 'Offline / Demo Mode' : 'Connected to API');

                const searchCourses = async () => {
                    loading.value = true;
                    errorMsg.value = '';
                    courses.value = [];
                    
                    const query = searchQuery.value.trim().toUpperCase() || 'ECON';

                    try {
                        console.log("Fetching: " + query);
                        const res = await fetch(`https://api.peterportal.org/rest/v0/courses?department=${query}`);
                        if (!res.ok) throw new Error("API Error");
                        
                        const data = await res.json();
                        courses.value = data.slice(0, 20); // 限制显示数量
                        
                    } catch (err) {
                        console.error(err);
                        errorMsg.value = "无法连接 PeterPortal API，已切换到演示数据。";
                        // 演示数据
                        courses.value = [
                            { id: 'DEMO 101', title: 'Network Error Demo', demoGPA: '4.00' },
                            { id: 'ECON 20A', title: 'Basic Economics I', demoGPA: '2.95' },
                            { id: 'WRITING 39C', title: 'Argument & Research', demoGPA: '3.80' }
                        ];
                    } finally {
                        loading.value = false;
                    }
                };

                const addToPlan = (c) => {
                    plannedCourses.value.push({
                        id: c.id,
                        title: c.title,
                        units: 4,
                        gradePoint: 4.0
                    });
                };

                const removeCourse = (i) => plannedCourses.value.splice(i, 1);

                onMounted(() => searchCourses());

                return {
                    courses, loading, errorMsg, searchQuery,
                    currentGPA, currentUnits, plannedCourses,
                    projectedGPA, statusColor, statusText,
                    searchCourses, addToPlan, removeCourse
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
